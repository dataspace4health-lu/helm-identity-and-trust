# -- Default number of instances to start 
replicaCount: 1
# -- Application name
name: wallet-api
# -- Ovverwrites application name
# nameOverride: "issuer"

image:
  # repository: docker.io
  repository: ds4h-registry:5432
  # -- Image name
  name: waltid/wallet-api
  # -- Image tag
  # Uses .Chart.AppVersion if empty
  #tag: "1.0.2501201345-SNAPSHOT"
  tag: latest
  # -- Image sha, usually generated by the CI
  # Uses image.tag if empty
  sha: ""
  # -- Image pull policy
  #pullPolicy: IfNotPresent
  pullPolicy: Always
  # -- Image pull secret when internal image is used
  #pullSecrets: deployment-key-light

## Use configMap or secretRef for environment variables
useConfigMap: false
configMapName: my-configmap
useSecretRef: false
secretRefName: my-secret

podAnnotations: {}

resources:
  requests:
    cpu: 150m
    memory: 128Mi
  limits:
    cpu: 300m
    memory: 600Mi

autoscaling:
  # -- Enable autoscaling
  enabled: false
  # -- Minimum replicas
  minReplicas: 2
  # -- Maximum replicas
  maxReplicas: 3
  # -- CPU target for autoscaling trigger
  targetCPUUtilizationPercentage: 70
  # -- Memory target for autoscaling trigger
  targetMemoryUtilizationPercentage: 70

metrics:
  # -- Enable prometheus metrics
  enabled: false #true
  # -- Port for prometheus metrics
  port: 2112

log:
  level: "debug"
  encoding: json

security:
  # -- by default, apps run as non-root
  runAsNonRoot: false
  # -- User used by the apps
  runAsUid: 0
  # -- Group used by the apps
  runAsGid: 0

service:
  port: 8080

postgresql:
  enabled: true
  image:
    registry: bitnamilegacy
    repository: postgresql
    tag: 16.2.0-debian-12-r18
  auth:
    postgresPassword: "xfsc4Ntt!"
    database: vc-wallet-api
    username: vc-wallet-api
    password: "xfsc4Ntt!"
  primary:
    persistence:
      enabled: true
      size: 5Gi

vault:
  enabled: true
  injector:
    enabled: false
  server:
    command:
      - /bin/bash
      - -c
      - |
        set -e 

        VAULT_DATA_PATH="/bitnami/vault/data"
        UNSEAL_LOG_FILE="${VAULT_DATA_PATH}/vault-unseal-log"
        
        if [[ ! -s "$UNSEAL_LOG_FILE" ]]; then
          echo "[INFO] First run â€” capturing unseal log."
          vault "$0" "$@" 2>&1 | tee "$UNSEAL_LOG_FILE"
        else
          echo "[INFO] Vault already initialized."
          sed "s|# ||g" /bitnami/vault/config/config.hcl > /bitnami/vault/data/config.hcl
          vault server -config=/bitnami/vault/data/config.hcl
        fi
    sidecars:
    - name: vault-unseal
      image: docker.io/bitnami/vault:1.17.1-debian-12-r3
      imagePullPolicy: Always
      command:
      - /bin/bash
      - -c
      - |
        set -e 

        VAULT_DATA_PATH="/bitnami/vault/data"
        UNSEAL_LOG_FILE="${VAULT_DATA_PATH}/vault-unseal-log"

        while [[ ! -s "$UNSEAL_LOG_FILE" || -z $(grep -m1 "Unseal Key:" "$UNSEAL_LOG_FILE") ]]; do
          echo "[INFO] Waiting for $UNSEAL_LOG_FILE to contain 'Unseal Key'..."
          sleep 3
        done
        
        UNSEAL_KEY=$(cat "$UNSEAL_LOG_FILE" | awk '/Unseal Key:/ { print $NF }')
        ROOT_TOKEN=$(cat "$UNSEAL_LOG_FILE" | awk '/Root Token:/ { print $NF }')

        export VAULT_ADDR=http://0.0.0.0:8200
        export VAULT_TOKEN=$ROOT_TOKEN

        # vault status return codes: 0 - unsealed; 1 - error; 2 - sealed
        until [[ $(vault status &>/dev/null; echo $?) -ne 1 ]]; do
          echo "[INFO] Waiting for Vault to be ready..."
          sleep 3
        done

        SEALED=$(vault status | grep Sealed | awk -F ' ' '{print $2}')
        if [[ "$SEALED" == "true" ]]; then
          echo "[INFO] Unsealing Vault..."
          vault operator unseal $UNSEAL_KEY > /dev/null 2>&1
          echo "[INFO] Vault unsealed successfully."
        fi

        if ! vault secrets list | grep -q "transit/"; then
          echo "[INFO] Enabling vault transit engine..."
          vault secrets enable transit > /dev/null 2>&1
          echo "[INFO] Transit engine enabled successfully."
        fi

        echo "[INFO] Sleeping..."
        sleep infinity
      volumeMounts:
      - name: data
        mountPath: /bitnami/vault/data
        readOnly: false
    args: 
      - server
      - -dev
      - -dev-root-token-id=root
      - -dev-listen-address=0.0.0.0:8200
      - -config=/bitnami/vault/config/config.hcl
    config: |
      disable_mlock = true
      ui = true
      # listener "tcp" {
      #   tls_disable = 1
      #   address = "0.0.0.0:8200"
      #   cluster_address = "0.0.0.0:8201"
      # }
      storage "raft" {
        path = "/bitnami/vault/data"
      }

      service_registration "kubernetes" {}
    persistence:
      size: 5Gi

config:
  walletUiPath: /wallet/ui
  waltidCustodianUrl: http://waltid-issuer-api.default.svc.cluster.local:7002
  init:
    account:
      name: "NTT Data"
      email: "wallet@ntt.com"
      pass: "xfsc4Ntt!"
  http:
    host: ""
    port: 8080
    timeout:
      idle: 120s
      read: 10s
      write: 10s
  persistance:
    size: 10Gi
  database:
    dataSource:
      jdbcUrl: null
      driverClassName: null
      username: null
      password: null
      transactionIsolation: "TRANSACTION_SERIALIZABLE"
      maximumPoolSize: 5
      autoCommit: false
      dataSource:
        journalMode: "WAL"
        fullColumnNames: false
    recreateDatabaseOnStart: false
  oidc:
    publicBaseUrl: "https://wallet-dev.walt.id"
    providerName: keycloak
    oidcRealm: "https://dataspace4health.local/iam/realms/ds4h"
    oidcJwks: "${oidcRealm}/protocol/openid-connect/certs"
    oidcScopes: ["openid", "roles"]
    authorizeUrl: "${oidcRealm}/protocol/openid-connect/auth"
    accessTokenUrl: "${oidcRealm}/protocol/openid-connect/token"
    logoutUrl: "${oidcRealm}/protocol/openid-connect/logout"
    clientId: "waltid_backend"
    clientSecret: "__DEFAULT_KEYCLOAK_CLIENT_SECRET__"
    keycloakUserApi: "https://dataspace4health.local/iam/admin/realms/ds4h/users"
    jwksCache:
      cacheSize: 10
      cacheExpirationHours: 24
      rateLimit:
        bucketSize: 10
        refillRateMinutes: 1
  auth:
    encryptionKey: "dncygwnvivxzlohc" # a 128 bit (16 chars) key
    signKey: "jyjeylmidlylokzh" # a 128 bit (16 chars) key
    # Available Signing Algorithms are: RS256 or HS256.
    # If HS256, then provide the 256+ bit key in the tokenKey field. If RS256, then provide the private key in JWK format in the tokenKey field.
    tokenKey: "hjklwcptiniwjkdwwkigreumcayoyiso" # at least 256 bit (32 chars)
    # Specify your iss and sub claims
    audTokenClaim: "https://dataspace4health.local"
    issTokenClaim: "https://dataspace4health.local"
    tokenLifetime: "30" # days
  registrationDefaults:
    vault:
      server: null
      accessKey: null
    did:
      domain: "dataspace4health.local"
      path: "/wallet/api"
    issuer:
      name: "ntt-data"
      description: "NTT Data Issuer"
      uiEndpoint: "https://dataspace4health.local/portal/credentials?ids="
      configurationEndpoint: "https://dataspace4health.local/issuer/api/.well-known/openid-credential-issuer"

ingress:
  enabled: true
  hosts:
    - paths:
      - path: /wallet/api
        port: 8080
        pathType: Prefix
  replacePath:
    regex: /wallet/api(/|$)(.*)
    replacement: /$2
  replaceHeader:
    header: Location
    regex: (/|^)swagger(.*)
    replacement: /wallet/api/swagger$2
  replaceBody:
    regex: (")?url(")?(\s)?(:) "\/("|api\.json")
    replacement: url $4 "/wallet/api/$5
    logLevel: -2
    monitoring:
      methods:
      - GET
      types:
      - "*/*"
      - application/javascript
      - application/json
  tls:
    - secretName: dataspace4health.local
      hosts:
        - dataspace4health.local

# istio:
#   injection:
#     pod: true
