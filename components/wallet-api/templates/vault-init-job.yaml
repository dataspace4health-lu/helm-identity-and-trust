{{- if .Values.vault.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "app.chartname" . }}-vault-server-init
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "app.labels" . | nindent 4 }}
    app.kubernetes.io/instance: {{ include "app.revision" . }}
    app.kubernetes.io/part-of: rse
    {{ include "app.istioLabels" . | nindent 4 }}
spec:
  ttlSecondsAfterFinished: 10
  template:
    spec:
      containers:
      - name: {{ template "app.chartname" . }}-vault-server-init
        image: {{ .Values.vault.server.image.registry }}/{{ .Values.vault.server.image.repository }}:{{ .Values.vault.server.image.tag }}
        command: ["sh", "-c"]
        args:
        - |
          set -e

          export VAULT_ADDR="http://{{ include "app.chartname" . }}-vault-server-headless.{{ .Release.Namespace }}.svc.cluster.local:8200"
          {{- range $index, $element := .Values.vault.server.args }}
          {{- if $element | regexMatch "-dev-root-token-id=.*" }}
            {{- $token := $element | regexFind "-dev-root-token-id=(.*)" }}
            {{- $token := regexReplaceAll "-dev-root-token-id=(.*)" $token "$1" }} 
          export VAULT_TOKEN={{ $token | quote }}
          {{- end }}
          {{- end }}
          
          echo "DEBUG: Waiting for Vault to be ready..."
          # give some time for Vault to start and be ready
          sleep 15

          echo "DEBUG: Testing Vault connectivity..."
          vault status

          echo "DEBUG: Logging into Vault..."
          vault login -no-store $VAULT_TOKEN

          echo "DEBUG: Checking if transit engine already exists..."
          # Check if transit engine is already enabled
          if vault secrets list | grep -q "transit/"; then
            echo "WARNING: Transit engine already enabled, skipping..."
          else
            echo "DEBUG: Enabling vault transit engine..."
            vault secrets enable transit
            echo "DEBUG: Transit engine enabled successfully"
          fi

          # create key1 with type ecdsa-p256
          #vault write -f transit/keys/key1 type=ecdsa-p256

          # create key2 with type ed25519
          #vault write -f transit/keys/key2 type=ed25519

          # create key3 with type rsa-4096
          #vault write -f transit/keys/key3 type=rsa-4096

          echo "DEBUG: Vault initialization completed successfully"
          exit
      restartPolicy: Never
  backoffLimit: 4
{{- end }}