{{- if and .Values.clients (gt (len .Values.clients) 0) }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "app.chartname" . }}-keycloak-client-init
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "app.labels" . | nindent 4 }}
    app.kubernetes.io/instance: {{ include "app.revision" . }}
    app.kubernetes.io/part-of: rse
    {{ include "app.istioLabels" . | nindent 4 }}
spec:
  ttlSecondsAfterFinished: 10
  template:
    spec:
      containers:
      - name: {{ template "app.chartname" . }}-keyclaok-client-init
        image: curlimages/curl:latest
        command: ["sh", "-c"]
        args:
        - |
          set -xe

          wait-for-url() {
            echo "Testing $1"
            timeout -s TERM 200 sh -c \
            'while [[ "$(curl -k -s -o /dev/null -L -w ''%{http_code}'' ${0})" != "200" ]];\
            do echo "Waiting for ${0}" && sleep 20;\
            done' ${1}
            echo "OK!"
          }

          #################################################
          # Wait Keycloak to be up and running
          #################################################
          keycloak_url=http://{{ template "app.chartname" . }}-keycloak{{ default "/" .Values.keycloak.httpRelativePath }}
          wait-for-url ${keycloak_url}realms/master
          
          {{- range .Values.clients }}
          {{- $realm := .realm }}
          #################################################
          # Get Keycloak token
          #################################################
          response=$(curl -k -s -w "|%{http_code}" -X POST \
            -H 'Content-Type: application/x-www-form-urlencoded' \
            -d "grant_type=password" \
            -d "client_id=admin-cli" \
            -d "username={{ .realmAdminUser }}" \
            -d "password={{ .realmAdminPass }}" \
            "${keycloak_url}realms/{{ $realm }}/protocol/openid-connect/token")
          body=$(echo $response | awk -F '|' '{print $1}')
          code=$(echo $response | awk -F '|' '{print $2}')
          if [ $code -eq 200 ]; then
            echo "Got Keycloak token"
          else
            echo "Bad Request"
            exit 1
          fi

          access_token=$(echo $body | grep -m1 -oE '"access_token":"[^"]+"' | awk -F ':' '{gsub(/"/,"",$2); print $2}')

          {{- range .issuers }}
          #################################################
          # Register client for issuer {{ .did }}
          #################################################
          response=$(curl -k -s -w "|%{http_code}" -X POST \
            -H 'Content-Type: application/json' \
            -H "Authorization: Bearer $access_token" \
            -d "{
              \"name\": \"siop-client\",
              \"clientDid\": \"{{ .did }}\",
              \"description\": \"Client to issue Verifiable Credentials.\",
              \"supportedVCTypes\": [
                {{- range $i, $elem := .supportedVCTypes }}
                {{- if gt $i 0 }},{{- end }}
                {
                  \"type\": \"{{ $elem.type }}\",
                  \"format\": \"{{ $elem.format }}\" 
                }
                {{- end }}
              ],
              \"expiryInMin\": 3600,
              \"additionalClaims\": {
                {{- $last := sub (len .additionalClaims) 1 }}
                {{- range $i, $elem := .additionalClaims }}
                \"{{ $elem.vcType }}_claims\": \"{{ $elem.claims }}\"
                {{- if ne $i $last }},{{- end }}
                {{- end }}
              }
            }" \
            "${keycloak_url}realms/{{ $realm }}/clients-registrations/SIOP-2")
          body=$(echo $response | awk -F '|' '{print $1}')
          code=$(echo $response | awk -F '|' '{print $2}')
          if [ $code -eq 201 ]; then
            echo "Client {{ .idpClientName }} registered"
          else
            echo "Bad Request"
            exit 1
          fi
          {{- end }}

          {{- range .identityProviders }}
          #################################################
          # Register client {{ .clientName }}
          #################################################
          response=$(curl -k -s -w "|%{http_code}" -X POST \
            -H 'Content-Type: application/json' \
            -d "{
              \"client_name\": \"{{ .clientName }}\",
              \"redirect_uris\": [ \"{{ .redirectUri }}\" ],
              \"all_redirect_uris\": false
            }" \
            "{{ .clientRegisterUrl }}")
          body=$(echo $response | awk -F '|' '{print $1}')
          code=$(echo $response | awk -F '|' '{print $2}')
          if [ $code -eq 201 ]; then
            echo "Client {{ .clientName }} registered"
          else
            echo "Bad Request"
            exit 1
          fi

          client_id=$(echo $body | grep -m1 -oE '"client_id": "[^"]+"' | awk -F ': ' '{gsub(/"/,"",$2); print $2}')
          client_secret=$(echo $body | grep -m1 -oE '"client_secret": "[^"]+"' | awk -F ': ' '{gsub(/"/,"",$2); print $2}')

          #################################################
          # Get idp {{ .alias }} metadata
          #################################################
          response=$(curl -k -s -w "|%{http_code}" -X GET \
            -H 'Content-Type: application/json' \
            "{{ .oidcDiscoveryUrl }}")
          body=$(echo $response | awk -F '|' '{print $1}')
          code=$(echo $response | awk -F '|' '{print $2}')
          if [ $code -eq 200 ]; then
            echo "Got idp {{ .alias }} metadata"
          else
            echo "Bad Request"
            exit 1
          fi

          authorization_url=$(echo $body | grep -m1 -oE '"authorization_endpoint": "[^"]+"' | awk -F ': ' '{gsub(/"/,"",$2); print $2}')
          token_url=$(echo $body | grep -m1 -oE '"token_endpoint": "[^"]+"' | awk -F ': ' '{gsub(/"/,"",$2); print $2}')
          user_info_url=$(echo $body | grep -m1 -oE '"userinfo_endpoint": "[^"]+"' | awk -F ': ' '{gsub(/"/,"",$2); print $2}')
          issuer=$(echo $body | grep -m1 -oE '"issuer": "[^"]+"' | awk -F ': ' '{gsub(/"/,"",$2); print $2}')
          jwks_url=$(echo $body | grep -m1 -oE '"jwks_uri": "[^"]+"' | awk -F ': ' '{gsub(/"/,"",$2); print $2}')
          
          #################################################
          # Register idp {{ .alias }} in Keycloak
          #################################################
          response=$(curl -k -s -w "|%{http_code}" -X POST \
            -H 'Content-Type: application/json' \
            -H "Authorization: Bearer $access_token" \
            -d "{
              \"providerId\": \"oidc\",
              \"alias\": \"{{ .alias }}\",
              \"displayName\": \"{{ .displayName }}\",
              \"config\": {
                \"authorizationUrl\": \"${authorization_url}\",
                \"tokenUrl\": \"${token_url}\",
                \"userInfoUrl\": \"${user_info_url}\",
                \"issuer\": \"${issuer}\",
                \"jwksUrl\": \"${jwks_url}\",
                \"clientAuthMethod\": \"client_secret_basic\",
                \"clientId\": \"${client_id}\",
                \"clientSecret\": \"${client_secret}\",
                \"defaultScope\": \"openid profile\"
              }
            }" \
            "${keycloak_url}admin/realms/{{ $realm }}/identity-provider/instances")
          body=$(echo $response | awk -F '|' '{print $1}')
          code=$(echo $response | awk -F '|' '{print $2}')
          if [ $code -eq 201 ]; then
            echo "IDP {{ .alias }} registered"
          else
            echo "Bad Request"
            exit 1
          fi
          {{- end }}

          {{- end }}

          exit 0
      restartPolicy: Never
  backoffLimit: 4
  {{- end }}




